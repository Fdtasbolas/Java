<html>
<head>
<link href="./styles/reset.css" media="all" rel="stylesheet" type="text/css"/>
<link href="./styles/base.css" media="all" rel="stylesheet" type="text/css"/>
<script src="cordova-2.4.0.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js" type="text/javascript"></script>
<script src="https://maps.googleapis.com/maps/api/js?sensor=true" type="text/javascript"></script>            
<script src="./scripts/LivingChoices.SearchRequest.js" type="text/javascript"></script>
<script src="./scripts/LivingChoices.AutoComplete.js" type="text/javascript"></script>
<script src="./scripts/LivingChoices.DataAccess.js" type="text/javascript"></script>
<script src="./scripts/handlebars.js" type="text/javascript"></script>
</head>
<body>
	<section class="search ac">
		<div style="padding-bottom: 10px;">
			<img src="./images/af_interiorpage_logo.png" />
			<div>Search smarter.  Live better.</div>
		</div>
		<div class="ui-widget">
	        <input autocomplete="off" style="width: 175px;" id="SearchText" name="SearchText" type="text" x-webkit-speech />
			<input class="btn-search" type="button" value="" />
		</div>
		<div>-------- or --------</div>
		<div class="clr"></div>
		<div class="geo-btn-search" style="width: auto; background-color: #e66500; color: #fff; border-radius: 2px; -webkit-border-radius: 2px; box-shadow: 0px 1px 4px #888; padding-bottom: 5px; cursor: pointer;">
			<img src="./images/target.png" />
			<span>Find apartments near me</span>
		</div>
	</section>
	<div class="list-view"></div>
	<script language="javascript">
	    var geocoder;
		$(document).ready(function ($) {
			AutoComplete.Initialize('http://services.apartmentfinder.com/autosuggest/location', 'CITY', $('#SearchText'), null, null, autoCompleteSelectedCallback);		
			$('.btn-search').click(search);
			geocoder = new google.maps.Geocoder();
			$('.geo-btn-search').click(searchByGeoLocation);
		});
		
	    function autoCompleteSelectedCallback(SearchType, SearchText) {
	        $('#SearchType').val(SearchType);
	        $('#SearchText').val(SearchText);
	        search();
	        $('#SearchText').blur();
	    }
		
		function search() {
			var searchText = $('#SearchText').val().split(',');
			var city = searchText[0].trim();
			var state = searchText[1].trim();
			var searchRequest = new SearchRequest(city, state);
			$.ajax({
				url: 'http://services.apartmentfinder.com/Apartments/Search',
				dataType: 'jsonp',
				data: searchRequest.JSON,
				success: searchCallback,
	            error: function (xhr, textStatus, errorString) {
	                console.log(textStatus);
	                console.log(errorString);
	            }
			});
		}
		
		function searchCallback(data){
			var source   = $("#apartmentList-template").html();
			var template = Handlebars.compile(source);
			$('.list-view').html( template(data.response.docs) );
		}
		
		function searchByGeoLocation(){
			navigator.geolocation.getCurrentPosition(getCurrentPositionCallback, function(){ console.log('geolocation failed'); });
		}
		
		function getCurrentPositionCallback(position){
		 	var lat = parseFloat(position.coords.latitude);
	      	var lng = parseFloat(position.coords.longitude);      	
			var latlng = new google.maps.LatLng(lat, lng);   
		    geocoder.geocode({'latLng': latlng}, reverseGeoCallback);
		}
		
		function reverseGeoCallback(results, status){
			var city, state;
			if (status == google.maps.GeocoderStatus.OK) {
		      if (results[0]) {
		        var arrAddress = results[0].address_components;
		        // iterate through address_component array
		        $.each(arrAddress, function (i, address_component) {
		          if (address_component.types[0] == 'locality') {
		            city = address_component.long_name;
		          }
		          else if(address_component.types[0] == 'administrative_area_level_1') {
		            state = address_component.short_name;
		          }
		        });
		        $('#SearchText').val(city + ', ' + state);
		        search();
		      } 
		      else {
		        console.log('No results found');
		      }
		    } 
		    else {
		      console.log('Geocoder failed due to: ' + status);
		    }
		}	
	</script>
	<script id="apartmentList-template" type="text/x-handlebars-template">
		<div class="results">
		  {{#each .}}
			<div class="listing basic">
				<div class="photo thumb"> 
					<a href="#"><img src="{{LThumbnailUrl}}" /></a>
				</div>
				<div class="summary" >
					<span class="name fl cb"> 
						  <a href="#" package-level="{{PackageLevel}}">{{Name}}</a>
					</span>
					<div class="clr"></div>
					<div class="info fl">
						<address class="address"><span class="street">{{Address}}, </span>{{City}}, {{State}} {{Zip}}<a class="sm-txt dn" href=""> Map</a></address>
						<div class="breakdown-range">
							<ul>
								<li><span class="room"><span>{{MinBedrooms}}</span> - <span>{{MaxBedrooms}} BR</span></span></li>
								<li><span class="price"><a href="#">{{NetMinPrice}}</a></span></li>
							</ul>
							<div class="clr"></div>
						</div>
						<div>
							<span class="phone spc">{{Phone}}</span> 
						</div>
					</div>
				</div>
				<div class="clr"></div>
			</div>
		  {{/each}}
		</div>
	</script>
</body>
</html>